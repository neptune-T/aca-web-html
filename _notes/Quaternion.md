---
title: 'Quaternions and 3D rotations '
date: '2025-10'
summary: '111'
tags: ['计算机图形学']
---

# 三维旋转表示的困境

在计算机图形学、机器人学、航空航天以及物理学的诸多领域中，精确描述和操作三维空间中的物体姿态是一项基本且核心的任务。一个物体的姿态本质上是其相对于某个参考坐标系的旋转状态。因此，寻找一种有效、稳定且无歧义的数学工具来表示旋转，便成为了一个根本性的问题。最符合人类直觉的表示方法是**欧拉角 (Euler Angles)**。该方法将一个复杂的空间旋转分解为三个沿着正交坐标轴（例如 x, y, z 轴）依次进行的简单旋转，这三个旋转的角度（例如，偏航角 Yaw, 俯仰角 Pitch, 滚转角 Roll）共同构成了对最终姿态的描述。欧拉角因其直观易懂而被广泛应用，然而，这种表示方法存在一个固有的、在关键应用中无法回避的致命缺陷——**万向节死锁 (Gimbal Lock)**。

万向节死锁是一种状态，在此状态下，旋转系统会失去一个自由度。以飞行器为例，当俯仰角为 $\pm90$ 度（即机头垂直朝上或朝下）时，原本用于控制偏航和滚转的两个旋转轴会发生重合。此时，无论系统尝试执行偏航还是滚转操作，都会产生完全相同的几何效果，即绕着同一个垂直轴旋转。这意味着飞行器在此姿态下无法独立完成所有三种类型的旋转，丧失了向任意方向调整姿态的能力。在动画或模拟中，当物体接近或进入万向节死锁状态时，其运动会表现出突然的、不自然的剧烈翻转，因为系统为了从一个姿态平滑插值到另一个姿态，可能需要进行一次幅度极大且不符合物理直觉的旋转。这种不稳定性使得欧拉角在要求高精度和高平滑度的应用中，成为了一种不可靠的表示方法。因此，为了克服这一根本性限制，数学家们寻求一种更高维度的、能够从本质上避免奇异状态的代数结构来描述旋转。


# 四元数的代数结构与核心性质

为了解决上一节提出的旋转表示困境，我们引入一种新的代数系统**四元数 (Quaternion)**。

从结构上看，一个四元数 $q$ 是一个由四部分组成的数，其一般形式为 $q = q_w + q_x i + q_y j + q_z k$。这里的系数 $q_w, q_x, q_y, q_z$ 都是我们熟悉的实数。$q_w$ 被称为**标量部 (scalar part)**，而由三个虚数单位 $i, j, k$ 构成的 $q_x i + q_y j + q_z k$ 则被称为**矢量部 (vector part)**。所有这些四元数的集合形成了一个数学家所称的、在实数域 $\mathbb{R}$ 上的四维代数，记为 $\mathbb{H}$。这意味着四元数不仅像向量一样可以进行加法和标量乘法，更重要的是，它们之间还定义了一套独特的乘法规则。

这套乘法规则完全由一个核心恒等式所支配：

$$
\begin{equation}
i^2 = j^2 = k^2 = ijk = -1
\end{equation}
$$ 

而四元数虚数单位的乘法遵循一个循环规则：$ i→j→k→i $，即正向相乘得正，反向相乘得负。比如说我们在等式 $1$ 右侧同乘以 $k$：

$$
\begin{equation}
(ijk)k = (-1)k
\end{equation}
$$

利用结合律和 $k^2 = -1$，得：
$$
\begin{align}
ij(-1) = -k 
\end{align}
$$

$$
\begin{equation}
    ij=k
\end{equation}
$$

根据上述推导，我们如果尝试计算 $ji$，就会发现结果变成了$ji = -(ij) = k$。这种乘法顺序会影响结果的特性，即**非交换性 (non-commutativity)**，是四元数与我们熟知的实数和复数最根本的区别。正是这种特性，使得四元数能够完美地捕捉三维空间旋转的非交换本质（例如，一个物体先绕垂直轴旋转90度再绕水平轴旋转90度，与颠倒顺序后的最终姿态是不同的）。

为了将这个代数系统应用于几何变换，我们必须定义几个关键的运算和属性，它们是后续所有操作的“零件”。

首先是**共轭 (Conjugate)**。这个概念是对复数共轭的自然推广。对于一个复数 $z=a+bi$，其共轭是 $z^*=a-bi$。类似地，对于四元数 $q = q_w + q_x i + q_y j + q_z k$，它的共轭 $q^*$ 就是将其所有矢量部分（虚部）的符号取反：$q^* = q_w - q_x i - q_y j - q_z k$。共轭运算的核心作用，是在不改变标量部的情况下“反转”其矢量方向，这在后续求模和求逆的运算中至关重要。

接下来是**模 (Norm)**，它用于衡量一个四元数的“大小”或“长度”。$q$ 的模记作 $\|q\|$，其定义源于四元数与其自身的共轭之积，$\|q\| = \sqrt{qq^*}$。我们可以展开这个乘积来理解其几何意义：
$$
\begin{equation}
qq^* = (q_w + (q_xi + q_yj + q_zk))(q_w - (q_xi + q_yj + q_zk))
\end{equation}
$$


展开这个乘积会得到9个项，我们可以将其分为两类：

* **对角项（同类单位相乘）：**
    * $(q_x i)(q_x i) = q_x^2 (i^2) = -q_x^2$
    * $(q_y j)(q_y j) = q_y^2 (j^2) = -q_y^2$
    * $(q_z k)(q_z k) = q_z^2 (k^2) = -q_z^2$

* **交叉项（不同单位相乘）：**
    * $(q_x i)(q_y j) = q_x q_y (ij) = q_x q_y k$
    * $(q_y j)(q_x i) = q_y q_x (ji) = -q_y q_x k$
    * ... 以此类推，我们会得到所有两两组合的乘积：
        * $q_y q_z (jk) = q_y q_z i$  与  $q_z q_y (kj) = -q_z q_y i$
        * $q_z q_x (ki) = q_z q_x j$  与  $q_x q_z (ik) = -q_x q_z j$

现在，我们将所有9个项相加。每一对交叉项（例如 $q_x q_y k$ 和 $-q_y q_x k$）都会因为四元数乘法的非交换性 ($ij = -ji$) 而精确地相互抵消。所有矢量部（带有 $i, j, k$ 的项）都消失了，剩下的只有对角项的和：$(q_x i + q_y j + q_z k)^2 = -q_x^2 - q_y^2 - q_z^2$。现在我们将这个结果代回到 $qq^*$ 的表达式中：
$$
\begin{equation}
qq^* = (q_w)^2 - (-(q_x^2 + q_y^2 + q_z^2))
\end{equation}
$$

$$
\begin{equation}
qq^* = q_w^2 + q_x^2 + q_y^2 + q_z^2
\end{equation}
$$

这个结果是一个纯粹的实数，没有任何虚部。根据我们对模的定义 $\|q\| = \sqrt{q_w^2 + q_x^2 + q_y^2 + q_z^2}$，上面这个结果恰好是模的平方，即 $\|q\|^2$。


有了共轭和模，我们便可以定义任何非零四元数 $q$ 的逆 (Inverse) $q^{-1}$，它满足乘法单位元的基本性质 $qq^{-1} = q^{-1}q = 1$。其计算公式为 $q^{-1} = \frac{q^*}{\|q\|^2}$。我们可以很容易地验证这个定义的正确性：

$$
\begin{equation}
q \cdot q^{-1} = q \cdot \frac{q^*}{\|q\|^2} = \frac{qq^*}{\|q\|^2} = \frac{\|q\|^2}{\|q\|^2} = 1
\end{equation}
$$

在表示纯粹的旋转时（即不含任何缩放或变形的变换），我们极其关心一类特殊的四元数——单位四元数 (Unit Quaternion)。顾名思义，它们是模为 1 ($\|q\|=1$) 的四元数。这个单位长度的约束，在几何上直观地对应了旋转操作不应改变物体大小的特性。当一个四元数是单位四元数时，它的求逆运算得到了极大的简化：由于分母 $\|q\|^2=1$，其逆就等于它的共轭，即 $q^{-1} = q^*$。这个优雅的性质不仅是理论上的一个美妙结果，更是四元数在实时计算机图形学和机器人学中得以高效应用的关键。它将一个可能涉及四次乘法和一次除法的求逆运算，简化为三次符号取反操作，极大地降低了计算成本。


# 三维旋转的四元数表示

现在任务是利用这些工具，将一个抽象的四元数与一个具体的三维空间旋转操作精确地等同起来。这个过程分为两步：首先，我们需要一种方式在四元数的世界里表示三维向量；其次，我们需要构造一个特定的四元数来编码旋转这个动作本身。

为了让四元数能够对三维向量进行操作，我们必须在三维欧几里得空间 $\mathbb{R}^3$ 与四元数空间 $\mathbb{H}$ 的某个子集之间建立一座桥梁。这个桥梁就是**纯四元数 (pure quaternion)** 空间，即所有标量部（实部）为零的四元数的集合。任何一个三维向量 $\vec{v} = (v_x, v_y, v_z)$ 都可以被唯一地表示为一个纯四元数 $v = 0 + v_x i + v_y j + v_z k$。反之，任何纯四元数也对应一个唯一的三维向量。这种对应的关系在数学上被称为**同构 (Isomorphism)**，它意味着我们可以将任何三维向量“嵌入”到四元数空间中进行代数运算，运算结束后再将结果“提取”回三维空间，而不会丢失任何信息。例如，一个向量 $\vec{v}=(2, -3, 5)$ 在四元数的世界中就以 $v = 2i - 3j + 5k$ 的形式存在。

现在我们有了代表“被旋转物体”（向量）的方式，接着需要表示“旋转动作”本身。三维空间中任何一个旋转操作，都可以由两个几何要素唯一确定：一个**旋转轴**，由一个单位向量 $\hat{u} \in \mathbb{R}^3$ 表示；以及一个**旋转角度** $\theta \in \mathbb{R}$，我们通常遵循右手定则，规定逆时针方向为正。我们的目标是构造一个**单位四元数** $q$，使其能够完整地编码这两个几何信息。该四元数的构造公式如下：

$$
\begin{equation}
q = \cos\left(\frac{\theta}{2}\right) + (u_x i + u_y j + u_z k)\sin\left(\frac{\theta}{2}\right)
\end{equation}
$$
我们可以将其简洁地记为 $q = \cos(\frac{\theta}{2}) + \hat{u}\sin(\frac{\theta}{2})$，其中 $\hat{u}$ 被理解为代表轴向量的纯四元数。这个构造式并非任意设计的，它具有一个至关重要的内禀性质：它确保了所构造的 $q$ **必然是一个单位四元数**。我们可以通过计算其模的平方来验证这一点：
$$
\begin{align}
\|q\|^2 &= \left(\cos\left(\frac{\theta}{2}\right)\right)^2 + \left(u_x \sin\left(\frac{\theta}{2}\right)\right)^2 
\\&+ \left(u_y \sin\left(\frac{\theta}{2}\right)\right)^2 + \left(u_z \sin\left(\frac{\theta}{2}\right)\right)^2  \nonumber 
\\ 
& = \cos^2\left(\frac{\theta}{2}\right) + (u_x^2 + u_y^2 + u_z^2)\sin^2\left(\frac{\theta}{2}\right)
\end{align}
$$


由于 $\hat{u}$ 是单位向量，所以 $u_x^2 + u_y^2 + u_z^2 = \|\hat{u}\|^2 = 1$。因此，上式根据三角函数的平方和定理，结果恒等于1。这个单位模长的性质保证了由该四元数引发的变换将是纯粹的旋转，不包含任何我们不希望的缩放效果。同时，您可能会注意到公式中**半角 $\theta/2$** 的使用。这并非巧合或近似，而是为下一节将要介绍的核心旋转算子所做的必要准备。该算子的数学结构将使角度效应被施加两次，因此我们在此预先使用半角，以确保最终的几何效果恰好是我们期望的旋转角度 $\theta$。













